# نظام الوصفات وإدارة المخزون - دليل البرومبت الكامل

## نظرة عامة
تم تطوير نظام متكامل لإدارة الوصفات والمواد الخام والمخزون في نظام المبيعات. النظام يقوم تلقائياً بخصم المواد الخام من المخزون عند إتمام الفواتير بناءً على الوصفات المحددة، ويعرض تحذيرات عند انخفاض المخزون.

## المكونات الرئيسية

### 1. قاعدة البيانات

#### جدول المواد الخام (raw_materials)
```sql
CREATE TABLE raw_materials (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  unit TEXT NOT NULL DEFAULT 'number',
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL
)
```

#### جدول دفعات المواد الخام (raw_material_batches)
```sql
CREATE TABLE raw_material_batches (
  id TEXT PRIMARY KEY,
  raw_material_id TEXT NOT NULL,
  quantity REAL NOT NULL,
  expiry_date TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (raw_material_id) REFERENCES raw_materials(id) ON DELETE CASCADE
)
```

#### جدول الوصفات (recipes)
```sql
CREATE TABLE recipes (
  id TEXT PRIMARY KEY,
  item_id TEXT NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE
)
```

#### جدول مكونات الوصفات (recipe_ingredients)
```sql
CREATE TABLE recipe_ingredients (
  id TEXT PRIMARY KEY,
  recipe_id TEXT NOT NULL,
  raw_material_id TEXT NOT NULL,
  quantity REAL NOT NULL,
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  FOREIGN KEY (recipe_id) REFERENCES recipes(id) ON DELETE CASCADE,
  FOREIGN KEY (raw_material_id) REFERENCES raw_materials(id) ON DELETE CASCADE
)
```

### 2. النماذج (Models)

#### LowStockWarning
نموذج يمثل تحذير من انخفاض المخزون:
- `rawMaterialId`: معرف المادة الخام
- `rawMaterialName`: اسم المادة الخام
- `currentQuantity`: الكمية الحالية
- `requiredQuantity`: الكمية المطلوبة
- `unit`: وحدة القياس
- `percentageRemaining`: النسبة المتبقية من المخزون
- `message`: رسالة التحذير
- `isCritical`: هل التحذير حرج (نفاد المخزون أو أقل من 10%)
- `isWarning`: هل التحذير عادي (أقل من 25%)

### 3. الخدمات (Services)

#### PurchaseService
تم تعديل خدمة الشراء لإضافة المواد الخام للمخزون تلقائياً:

**الوظيفة الجديدة: `_addRawMaterialToInventory`**
- تتحقق من أن العنصر المشترى هو مادة خام (بمطابقة الاسم أو المعرف)
- إذا كانت مادة خام، تضيف دفعة جديدة إلى `raw_material_batches`
- تاريخ انتهاء الصلاحية الافتراضي: 30 يوماً من تاريخ الشراء

**كيفية العمل:**
1. عند حفظ فاتورة شراء، يتم استدعاء `_addRawMaterialToInventory` لكل عنصر
2. البحث عن المادة الخام بمطابقة المعرف أولاً، ثم الاسم
3. إنشاء دفعة جديدة وإضافتها للمخزون

#### PaymentService
تم تعديل خدمة الدفع لخصم المخزون وعرض التحذيرات:

**التعديلات:**
1. `processPayment` الآن ترجع `({Sale sale, List<LowStockWarning> warnings})`
2. يتم جمع جميع التحذيرات من جميع العناصر المباعة
3. يتم إرجاع التحذيرات مع الفاتورة

**تدفق العمل:**
1. حفظ الفاتورة في قاعدة البيانات
2. لكل عنصر في الفاتورة:
   - البحث عن الوصفة المرتبطة بالعنصر
   - إذا وُجدت وصفة، استدعاء `deductInventoryForSale`
   - جمع التحذيرات من انخفاض المخزون
3. إرجاع الفاتورة والتحذيرات

### 4. قاعدة البيانات - DatabaseHelper

#### `deductInventoryForSale`
تم تعديل الدالة لإرجاع قائمة بالتحذيرات:

**المدخلات:**
- `itemId`: معرف العنصر المباع
- `quantity`: الكمية المباعة

**المخرجات:**
- `List<LowStockWarning>`: قائمة بالتحذيرات

**كيفية العمل:**
1. البحث عن الوصفة المرتبطة بالعنصر
2. لكل مكون في الوصفة:
   - حساب الكمية المطلوبة (كمية المكون × كمية العنصر المباع)
   - الحصول على جميع الدفعات للمادة الخام (مرتبة حسب تاريخ انتهاء الصلاحية - FIFO)
   - خصم الكمية المطلوبة من الدفعات
   - حذف الدفعات التي أصبحت فارغة
   - التحقق من انخفاض المخزون بعد الخصم
3. إرجاع قائمة التحذيرات

#### `_checkLowStock`
دالة مساعدة للتحقق من انخفاض المخزون:

**المعايير:**
- الكمية الآمنة الدنيا = الكمية المطلوبة × 10
- إذا كانت الكمية الحالية ≤ 0 أو أقل من 25% من الكمية الآمنة → تحذير
- إذا كانت أقل من 10% → تحذير حرج

### 5. واجهة المستخدم - POS Screen

#### `_showLowStockWarnings`
دالة لعرض التحذيرات للمستخدم:

**السلوك:**
1. فصل التحذيرات الحرجة عن العادية
2. إذا وُجدت تحذيرات حرجة:
   - عرض Dialog مع قائمة بالتحذيرات الحرجة
   - إضافة التحذيرات العادية في نفس الـ Dialog
3. إذا وُجدت تحذيرات عادية فقط:
   - عرض SnackBar مع قائمة التحذيرات

**التصميم:**
- أيقونات مختلفة للتحذيرات الحرجة (خطأ أحمر) والعادية (تحذير برتقالي)
- رسائل واضحة بالعربية
- إمكانية إغلاق التحذيرات

## تدفق العمل الكامل

### عند الشراء (Purchase Invoice):
1. المستخدم يدخل فاتورة شراء
2. `PurchaseService.savePurchaseInvoice` يتم استدعاؤها
3. لكل عنصر في الفاتورة:
   - تحديث مخزون العنصر (إن وُجد في جدول items)
   - التحقق إذا كان العنصر مادة خام
   - إذا كان مادة خام، إضافة دفعة جديدة إلى `raw_material_batches`
4. حفظ الفاتورة

### عند البيع (Sale Invoice):
1. المستخدم يكمل عملية الدفع
2. `PaymentService.processPayment` يتم استدعاؤها
3. حفظ الفاتورة في قاعدة البيانات
4. لكل عنصر في الفاتورة:
   - البحث عن الوصفة المرتبطة
   - إذا وُجدت وصفة:
     - خصم المواد الخام من المخزون حسب الوصفة
     - جمع التحذيرات من انخفاض المخزون
5. عرض التحذيرات للمستخدم (إن وُجدت)
6. عرض رسالة نجاح العملية

## مثال عملي

### سيناريو: بيع قهوة

**الوصفة:**
- قهوة (1 كوب) تحتاج:
  - 20 جرام قهوة
  - 250 مل ماء
  - 5 جرام سكر

**عند بيع 5 أكواب:**
1. النظام يبحث عن وصفة القهوة
2. يحسب الكميات المطلوبة:
   - قهوة: 20 × 5 = 100 جرام
   - ماء: 250 × 5 = 1250 مل
   - سكر: 5 × 5 = 25 جرام
3. يخصم من الدفعات (FIFO)
4. يتحقق من المخزون المتبقي
5. إذا كان المخزون منخفض، يعرض تحذير

## الميزات

### ✅ الميزات المطبقة:
1. **إضافة تلقائية للمواد الخام عند الشراء**
   - التحقق التلقائي من أن العنصر المشترى مادة خام
   - إضافة دفعات جديدة مع تاريخ انتهاء صلاحية

2. **خصم تلقائي من المخزون عند البيع**
   - استخدام الوصفات لحساب الكميات المطلوبة
   - خصم من الدفعات حسب FIFO (أول ما يدخل أول ما يخرج)
   - حذف الدفعات الفارغة تلقائياً

3. **نظام تحذيرات ذكي**
   - تحذيرات حرجة عند نفاد المخزون أو انخفاضه جداً (<10%)
   - تحذيرات عادية عند انخفاض المخزون (<25%)
   - رسائل واضحة بالعربية

4. **واجهة مستخدم متكاملة**
   - عرض Dialog للتحذيرات الحرجة
   - عرض SnackBar للتحذيرات العادية
   - تصميم واضح وسهل القراءة

## ملاحظات مهمة

### 1. مطابقة المواد الخام
النظام يبحث عن المواد الخام بطريقتين:
- أولاً: بمطابقة المعرف (itemId)
- ثانياً: بمطابقة الاسم (case-insensitive)

**توصية:** يجب أن تكون أسماء المواد الخام في جدول `raw_materials` مطابقة تماماً لأسماء العناصر المشتراة.

### 2. حساب الكمية الآمنة
الكمية الآمنة الدنيا = الكمية المطلوبة × 10

هذا يعني أن النظام يعتبر المخزون منخفضاً إذا كان أقل من 10 أضعاف الكمية المطلوبة في عملية بيع واحدة.

**مثال:** إذا كانت عملية بيع تحتاج 100 جرام، النظام يعتبر المخزون منخفضاً إذا كان أقل من 1000 جرام.

### 3. تاريخ انتهاء الصلاحية
عند الشراء، يتم تعيين تاريخ انتهاء صلاحية افتراضي = تاريخ الشراء + 30 يوماً.

**يمكن التعديل:** في `PurchaseService._addRawMaterialToInventory`، يمكن تغيير مدة الـ 30 يوماً حسب الحاجة.

### 4. معالجة الأخطاء
- إذا لم تُوجد وصفة لعنصر، يتم تخطي خصم المخزون (مع تسجيل تحذير في الـ logs)
- إذا لم تُوجد مادة خام مطابقة، يتم تخطي إضافة الدفعة (مع تسجيل في الـ logs)
- الأخطاء في خصم المخزون لا تمنع إتمام عملية البيع

## التطوير المستقبلي

### تحسينات مقترحة:
1. **إدارة تاريخ انتهاء الصلاحية**
   - إدخال تاريخ انتهاء صلاحية يدوياً عند الشراء
   - تحذيرات عند اقتراب انتهاء الصلاحية

2. **تقارير المخزون**
   - تقرير بالمواد الخام المنخفضة
   - تقرير بالحركات اليومية
   - تقرير بالدفعات المنتهية الصلاحية

3. **إعدادات متقدمة**
   - تحديد نسبة التحذير (حالياً 25%)
   - تحديد مضاعف الكمية الآمنة (حالياً 10x)
   - تحديد مدة انتهاء الصلاحية الافتراضية (حالياً 30 يوماً)

4. **ربط أفضل بين Items و Raw Materials**
   - إضافة حقل `raw_material_id` في جدول `items`
   - أو إضافة جدول ربط منفصل

## الخلاصة

تم تطوير نظام متكامل لإدارة الوصفات والمخزون يعمل تلقائياً:
- ✅ يضيف المواد الخام للمخزون عند الشراء
- ✅ يخصم من المخزون عند البيع حسب الوصفات
- ✅ يعرض تحذيرات ذكية عند انخفاض المخزون
- ✅ واجهة مستخدم واضحة وسهلة الاستخدام

النظام جاهز للاستخدام ويمكن تطويره حسب الحاجة.

